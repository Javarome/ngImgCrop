!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core")):"function"==typeof define&&define.amd?define("ng-img-crop",["exports","@angular/core"],t):t(e["ng-img-crop"]={},e.ng.core)}(this,function(e,i){"use strict";var s=function(){function e(){this.events={}}return e.prototype.on=function(e,t){var i=this;return e.split(" ").forEach(function(e){i.events[e]||(i.events[e]=[]),i.events[e].push(t)}),this},e.prototype.trigger=function(e,t){var i=this.events[e];return i&&i.forEach(function(e){e.call(null,t)}),this},e}(),l=function(){function l(){}return l.readIPTCData=function(e,t,i){for(var s,r,a,o,n=new DataView(e),h={},c=t;c<t+i;)28===n.getUint8(c)&&2===n.getUint8(c+1)&&(o=n.getUint8(c+2))in l.IptcFieldMap&&(a=n.getInt16(c+3),r=l.IptcFieldMap[o],s=l.getStringFromDB(n,c+5,a),h.hasOwnProperty(r)?h[r]instanceof Array?h[r].push(s):h[r]=[h[r],s]:h[r]=s),c++;return h},l.readTags=function(e,t,i,s,r){var a,o,n,h=e.getUint16(i,!r),c={};for(n=0;n<h;n++)a=i+12*n+2,(o=s[e.getUint16(a,!r)])?c[o]=l.readTagValue(e,a,t,i,r):console.warn("Unknown tag: "+e.getUint16(a,!r));return c},l.readTagValue=function(e,t,i,s,r){var a,o,n,h,c,l,g=e.getUint16(t+2,!r),u=e.getUint32(t+4,!r),d=e.getUint32(t+8,!r)+i;switch(g){case"1":case"7":if(1==u)return e.getUint8(t+8,!r);for(a=4<u?d:t+8,o=[],h=0;h<u;h++)o[h]=e.getUint8(a+h);return o;case"2":return a=4<u?d:t+8,this.getStringFromDB(e,a,u-1);case"3":if(1==u)return e.getUint16(t+8,!r);for(a=2<u?d:t+8,o=[],h=0;h<u;h++)o[h]=e.getUint16(a+2*h,!r);return o;case"4":if(1==u)return e.getUint32(t+8,!r);for(o=[],h=0;h<u;h++)o[h]=e.getUint32(d+4*h,!r);return o;case"5":if(1==u)return c=e.getUint32(d,!r),l=e.getUint32(d+4,!r),(n=new Number(c/l)).numerator=c,n.denominator=l,n;for(o=[],h=0;h<u;h++)c=e.getUint32(d+8*h,!r),l=e.getUint32(d+4+8*h,!r),o[h]=new Number(c/l),o[h].numerator=c,o[h].denominator=l;return o;case"9":if(1==u)return e.getInt32(t+8,!r);for(o=[],h=0;h<u;h++)o[h]=e.getInt32(d+4*h,!r);return o;case"10":if(1==u)return e.getInt32(d,!r)/e.getInt32(d+4,!r);for(o=[],h=0;h<u;h++)o[h]=e.getInt32(d+8*h,!r)/e.getInt32(d+4+8*h,!r);return o}},l.addEvent=function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent&&e.attachEvent("on"+t,i)},l.objectURLToBlob=function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="blob",i.onload=function(e){200!=this.status&&0!==this.status||t(this.response)},i.send()},l.handleBinaryFile=function(e,t,i){var s=l.findEXIFinJPEG(e),r=l.findIPTCinJPEG(e);t.exifdata=s||{},t.iptcdata=r||{},i&&i.call(t)},l.getImageData=function(t,i){var s=this;if(t.src)if(/^data\:/i.test(t.src)){var e=l.base64ToArrayBuffer(t.src);this.handleBinaryFile(e,t,i)}else if(/^blob\:/i.test(t.src)){(o=new FileReader).onload=function(e){s.handleBinaryFile(e.target.result,t,i)},l.objectURLToBlob(t.src,function(e){o.readAsArrayBuffer(e)})}else{var r=new XMLHttpRequest,a=this;r.onload=function(){if(200!=this.status&&0!==this.status)throw"Could not load image";a.handleBinaryFile(r.response,t,i),r=null},r.open("GET",t.src,!0),r.responseType="arraybuffer",r.send(null)}else if(FileReader&&(t instanceof window.Blob||t instanceof File)){var o;(o=new FileReader).onload=function(e){console.debug("getImageData: Got file of length %o",e.target.result.byteLength),s.handleBinaryFile(e.target.result,t,i)},o.readAsArrayBuffer(t)}},l.getStringFromDB=function(e,t,i){for(var s="",r=t;r<t+i;r++)s+=String.fromCharCode(e.getUint8(r));return s},l.readEXIFData=function(e,t){if("Exif"!=this.getStringFromDB(e,t,4))return console.error("Not valid EXIF data! "+this.getStringFromDB(e,t,4)),!1;var i,s,r,a,o,n=t+6;if(18761==e.getUint16(n))i=!1;else{if(19789!=e.getUint16(n))return console.error("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;i=!0}if(42!=e.getUint16(n+2,!i))return console.error("Not valid TIFF data! (no 0x002A)"),!1;var h=e.getUint32(n+4,!i);if(h<8)return console.error("Not valid TIFF data! (First offset less than 8)",e.getUint32(n+4,!i)),!1;if((s=l.readTags(e,n,n+h,this.TiffTags,i)).ExifIFDPointer)for(o in r=l.readTags(e,n,n+s.ExifIFDPointer,this.ExifTags,i)){switch(o){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":r[o]=this.StringValues[o][r[o]];break;case"ExifVersion":case"FlashpixVersion":r[o]=String.fromCharCode(r[o][0],r[o][1],r[o][2],r[o][3]);break;case"ComponentsConfiguration":r[o]=this.StringValues.Components[r[o][0]]+this.StringValues.Components[r[o][1]]+this.StringValues.Components[r[o][2]]+this.StringValues.Components[r[o][3]]}s[o]=r[o]}if(s.GPSInfoIFDPointer)for(o in a=this.readTags(e,n,n+s.GPSInfoIFDPointer,this.GPSTags,i)){switch(o){case"GPSVersionID":a[o]=a[o][0]+"."+a[o][1]+"."+a[o][2]+"."+a[o][3]}s[o]=a[o]}return s},l.getData=function(e,t){return!((e instanceof Image||e instanceof HTMLImageElement)&&!e.complete)&&(this.imageHasData(e)?t&&t.call(e):l.getImageData(e,t),!0)},l.getTag=function(e,t){if(this.imageHasData(e))return e.exifdata[t]},l.getAllTags=function(e){if(!this.imageHasData(e))return{};var t,i=e.exifdata,s={};for(t in i)i.hasOwnProperty(t)&&(s[t]=i[t]);return s},l.pretty=function(e){if(!this.imageHasData(e))return"";var t,i=e.exifdata,s="";for(t in i)i.hasOwnProperty(t)&&("object"==typeof i[t]?i[t]instanceof Number?s+=t+" : "+i[t]+" ["+i[t].numerator+"/"+i[t].denominator+"]\r\n":s+=t+" : ["+i[t].length+" values]\r\n":s+=t+" : "+i[t]+"\r\n");return s},l.findEXIFinJPEG=function(e){var t=new DataView(e),i=t.byteLength-4;if(console.debug("findEXIFinJPEG: Got file of length %o",e.byteLength),65496!==t.getUint16(0))return console.warn("Not a valid JPEG"),!1;var s,r,a=2;function o(){var e=t.getUint8(a);return a++,e}for(;a<i;){var n=o();if(255!=n)return console.error("Not a valid marker at offset "+a+", found: "+n),!1;s=o(),console.debug("Marker=%o",s);var h=(void 0,r=t.getUint16(a),a+=2,r-2);switch(s){case"0xE1":return this.readEXIFData(t,a);case"0xE0":default:a+=h}}},l.findIPTCinJPEG=function(e){var t=new DataView(e);if(console.debug("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return console.warn("Not a valid JPEG"),!1;for(var i,s,r=2,a=e.byteLength;r<a;){if(s=r,56===(i=t).getUint8(s)&&66===i.getUint8(s+1)&&73===i.getUint8(s+2)&&77===i.getUint8(s+3)&&4===i.getUint8(s+4)&&4===i.getUint8(s+5)){var o=t.getUint8(r+7);o%2!=0&&(o+=1),0===o&&(o=4);var n=r+8+o,h=t.getUint16(r+6+o);return this.readIPTCData(e,n,h)}r++}},l.readFromBinaryFile=function(e){return l.findEXIFinJPEG(e)},l.imageHasData=function(e){return!!e.exifdata},l.base64ToArrayBuffer=function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(e),s=i.length,r=new ArrayBuffer(s),a=new Uint8Array(r),o=0;o<s;o++)a[o]=i.charCodeAt(o);return r},l.ExifTags={"0x9000":"ExifVersion","0xA000":"FlashpixVersion","0xA001":"ColorSpace","0xA002":"PixelXDimension","0xA003":"PixelYDimension","0x9101":"ComponentsConfiguration","0x9102":"CompressedBitsPerPixel","0x927C":"MakerNote","0x9286":"UserComment","0xA004":"RelatedSoundFile","0x9003":"DateTimeOriginal","0x9004":"DateTimeDigitized","0x9290":"SubsecTime","0x9291":"SubsecTimeOriginal","0x9292":"SubsecTimeDigitized","0x829A":"ExposureTime","0x829D":"FNumber","0x8822":"ExposureProgram","0x8824":"SpectralSensitivity","0x8827":"ISOSpeedRatings","0x8828":"OECF","0x9201":"ShutterSpeedValue","0x9202":"ApertureValue","0x9203":"BrightnessValue","0x9204":"ExposureBias","0x9205":"MaxApertureValue","0x9206":"SubjectDistance","0x9207":"MeteringMode","0x9208":"LightSource","0x9209":"Flash","0x9214":"SubjectArea","0x920A":"FocalLength","0xA20B":"FlashEnergy","0xA20C":"SpatialFrequencyResponse","0xA20E":"FocalPlaneXResolution","0xA20F":"FocalPlaneYResolution","0xA210":"FocalPlaneResolutionUnit","0xA214":"SubjectLocation","0xA215":"ExposureIndex","0xA217":"SensingMethod","0xA300":"FileSource","0xA301":"SceneType","0xA302":"CFAPattern","0xA401":"CustomRendered","0xA402":"ExposureMode","0xA403":"WhiteBalance","0xA404":"DigitalZoomRation","0xA405":"FocalLengthIn35mmFilm","0xA406":"SceneCaptureType","0xA407":"GainControl","0xA408":"Contrast","0xA409":"Saturation","0xA40A":"Sharpness","0xA40B":"DeviceSettingDescription","0xA40C":"SubjectDistanceRange","0xA005":"InteroperabilityIFDPointer","0xA420":"ImageUniqueID"},l.TiffTags={"0x0100":"ImageWidth","0x0101":"ImageHeight","0x8769":"ExifIFDPointer","0x8825":"GPSInfoIFDPointer","0xA005":"InteroperabilityIFDPointer","0x0102":"BitsPerSample","0x0103":"Compression","0x0106":"PhotometricInterpretation","0x0112":"Orientation","0x0115":"SamplesPerPixel","0x011C":"PlanarConfiguration","0x0212":"YCbCrSubSampling","0x0213":"YCbCrPositioning","0x011A":"XResolution","0x011B":"YResolution","0x0128":"ResolutionUnit","0x0111":"StripOffsets","0x0116":"RowsPerStrip","0x0117":"StripByteCounts","0x0201":"JPEGInterchangeFormat","0x0202":"JPEGInterchangeFormatLength","0x012D":"TransferFunction","0x013E":"WhitePoint","0x013F":"PrimaryChromaticities","0x0211":"YCbCrCoefficients","0x0214":"ReferenceBlackWhite","0x0132":"DateTime","0x010E":"ImageDescription","0x010F":"Make","0x0110":"Model","0x0131":"Software","0x013B":"Artist","0x8298":"Copyright"},l.GPSTags={"0x0000":"GPSVersionID","0x0001":"GPSLatitudeRef","0x0002":"GPSLatitude","0x0003":"GPSLongitudeRef","0x0004":"GPSLongitude","0x0005":"GPSAltitudeRef","0x0006":"GPSAltitude","0x0007":"GPSTimeStamp","0x0008":"GPSSatellites","0x0009":"GPSStatus","0x000A":"GPSMeasureMode","0x000B":"GPSDOP","0x000C":"GPSSpeedRef","0x000D":"GPSSpeed","0x000E":"GPSTrackRef","0x000F":"GPSTrack","0x0010":"GPSImgDirectionRef","0x0011":"GPSImgDirection","0x0012":"GPSMapDatum","0x0013":"GPSDestLatitudeRef","0x0014":"GPSDestLatitude","0x0015":"GPSDestLongitudeRef","0x0016":"GPSDestLongitude","0x0017":"GPSDestBearingRef","0x0018":"GPSDestBearing","0x0019":"GPSDestDistanceRef","0x001A":"GPSDestDistance","0x001B":"GPSProcessingMethod","0x001C":"GPSAreaInformation","0x001D":"GPSDateStamp","0x001E":"GPSDifferential"},l.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{"0x0000":"Flash did not fire","0x0001":"Flash fired","0x0005":"Strobe return light not detected","0x0007":"Strobe return light detected","0x0009":"Flash fired, compulsory flash mode","0x000D":"Flash fired, compulsory flash mode, return light not detected","0x000F":"Flash fired, compulsory flash mode, return light detected","0x0010":"Flash did not fire, compulsory flash mode","0x0018":"Flash did not fire, auto mode","0x0019":"Flash fired, auto mode","0x001D":"Flash fired, auto mode, return light not detected","0x001F":"Flash fired, auto mode, return light detected","0x0020":"No flash function","0x0041":"Flash fired, red-eye reduction mode","0x0045":"Flash fired, red-eye reduction mode, return light not detected","0x0047":"Flash fired, red-eye reduction mode, return light detected","0x0049":"Flash fired, compulsory flash mode, red-eye reduction mode","0x004D":"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected","0x004F":"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected","0x0059":"Flash fired, auto mode, red-eye reduction mode","0x005D":"Flash fired, auto mode, return light not detected, red-eye reduction mode","0x005F":"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},l.IptcFieldMap={"0x78":"caption","0x6E":"credit","0x19":"keywords","0x37":"dateCreated","0x50":"byline","0x55":"bylineTitle","0x7A":"captionWriter","0x69":"headline","0x74":"copyright","0x0F":"category"},l}(),r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function t(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var a=function(){function e(e){this.ctx=e,this.shapeArrowNW=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],this.shapeArrowNE=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],this.shapeArrowSW=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],this.shapeArrowSE=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],this.shapeArrowN=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],this.shapeArrowW=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],this.shapeArrowS=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],this.shapeArrowE=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],this.colors={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"}}return e.prototype.calcPoint=function(e,t,i){return[i*e[0]+t[0],i*e[1]+t[1]]},e.prototype.drawFilledPolygon=function(e,t,i,s){var r;this.ctx.save(),this.ctx.fillStyle=t,this.ctx.beginPath();var a=this.calcPoint(e[0],i,s);for(var o in this.ctx.moveTo(a[0],a[1]),e){var n=parseInt(o,10);0<n&&(r=this.calcPoint(e[n],i,s),this.ctx.lineTo(r[0],r[1]))}this.ctx.lineTo(a[0],a[1]),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()},e.prototype.drawIconMove=function(e,t){this.drawFilledPolygon(this.shapeArrowN,this.colors.moveIconFill,e,t),this.drawFilledPolygon(this.shapeArrowW,this.colors.moveIconFill,e,t),this.drawFilledPolygon(this.shapeArrowS,this.colors.moveIconFill,e,t),this.drawFilledPolygon(this.shapeArrowE,this.colors.moveIconFill,e,t)},e.prototype.drawIconResizeCircle=function(e,t,i){var s=t*i;this.ctx.save(),this.ctx.strokeStyle=this.colors.resizeCircleStroke,this.ctx.lineWidth=2,this.ctx.fillStyle=this.colors.resizeCircleFill,this.ctx.beginPath(),this.ctx.arc(e[0],e[1],s,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},e.prototype.drawIconResizeBoxBase=function(e,t,i){var s=t*i;this.ctx.save(),this.ctx.strokeStyle=this.colors.resizeBoxStroke,this.ctx.lineWidth=2,this.ctx.fillStyle=this.colors.resizeBoxFill,this.ctx.fillRect(e[0]-s/2,e[1]-s/2,s,s),this.ctx.strokeRect(e[0]-s/2,e[1]-s/2,s,s),this.ctx.restore()},e.prototype.drawIconResizeBoxNESW=function(e,t,i){this.drawIconResizeBoxBase(e,t,i),this.drawFilledPolygon(this.shapeArrowNE,this.colors.resizeBoxArrowFill,e,i),this.drawFilledPolygon(this.shapeArrowSW,this.colors.resizeBoxArrowFill,e,i)},e.prototype.drawIconResizeBoxNWSE=function(e,t,i){this.drawIconResizeBoxBase(e,t,i),this.drawFilledPolygon(this.shapeArrowNW,this.colors.resizeBoxArrowFill,e,i),this.drawFilledPolygon(this.shapeArrowSE,this.colors.resizeBoxArrowFill,e,i)},e.prototype.drawCropArea=function(e,t,i,s){var r=e.width/this.ctx.canvas.width,a=e.height/this.ctx.canvas.height,o=t[0]-i/2,n=t[1]-i/2;this.ctx.save(),this.ctx.strokeStyle=this.colors.areaOutline,this.ctx.lineWidth=2,this.ctx.beginPath(),s(this.ctx,t,i),this.ctx.stroke(),this.ctx.clip(),0<i&&this.ctx.drawImage(e,o*r,n*a,i*r,i*a,o,n,i,i),this.ctx.beginPath(),s(this.ctx,t,i),this.ctx.stroke(),this.ctx.clip(),this.ctx.restore()},e}(),o="square",n=function(){function e(e,t){this._ctx=e,this._events=t,this._minSize=80,this._image=new Image,this._x=0,this._y=0,this._size=200,this._cropCanvas=new a(e)}return e.prototype.getImage=function(){return this._image},e.prototype.setImage=function(e){this._image=e},e.prototype.getX=function(){return this._x},e.prototype.setX=function(e){this._x=e,this._dontDragOutside()},e.prototype.getY=function(){return this._y},e.prototype.setY=function(e){this._y=e,this._dontDragOutside()},e.prototype.getSize=function(){return this._size},e.prototype.setSize=function(e){this._size=Math.max(this._minSize,e),this._dontDragOutside()},e.prototype.getMinSize=function(){return this._minSize},e.prototype.setMinSize=function(e){this._minSize=e,this._size=Math.max(this._minSize,this._size),this._dontDragOutside()},e.prototype._dontDragOutside=function(){var e=this._ctx.canvas.height,t=this._ctx.canvas.width;this._size>t&&(this._size=t),this._size>e&&(this._size=e),this._x<this._size/2&&(this._x=this._size/2),this._x>t-this._size/2&&(this._x=t-this._size/2),this._y<this._size/2&&(this._y=this._size/2),this._y>e-this._size/2&&(this._y=e-this._size/2)},e.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._size,this._drawArea)},e}(),h=function(s){function e(e,t){var i=s.call(this,e,t)||this;return i._boxResizeBaseSize=20,i._boxResizeNormalRatio=.9,i._boxResizeHoverRatio=1.2,i._iconMoveNormalRatio=.9,i._iconMoveHoverRatio=1.2,i._posDragStartX=0,i._posDragStartY=0,i._posResizeStartX=0,i._posResizeStartY=0,i._posResizeStartSize=0,i._boxResizeIsHover=!1,i._areaIsHover=!1,i._boxResizeIsDragging=!1,i._areaIsDragging=!1,i._boxResizeNormalSize=i._boxResizeBaseSize*i._boxResizeNormalRatio,i._boxResizeHoverSize=i._boxResizeBaseSize*i._boxResizeHoverRatio,i}return t(e,s),e.prototype._calcCirclePerimeterCoords=function(e){var t=this._size/2,i=e*(Math.PI/180);return[this._x+t*Math.cos(i),this._y+t*Math.sin(i)]},e.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)},e.prototype._isCoordWithinArea=function(e){return Math.sqrt((e[0]-this._x)*(e[0]-this._x)+(e[1]-this._y)*(e[1]-this._y))<this._size/2},e.prototype._isCoordWithinBoxResize=function(e){var t=this._calcResizeIconCenterCoords(),i=this._boxResizeHoverSize/2;return e[0]>t[0]-i&&e[0]<t[0]+i&&e[1]>t[1]-i&&e[1]<t[1]+i},e.prototype._drawArea=function(e,t,i){e.arc(t[0],t[1],i/2,0,2*Math.PI)},e.prototype.draw=function(){n.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio),this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)},e.prototype.processMouseMove=function(e,t){var i="default",s=!1;if(this._boxResizeIsHover=!1,this._areaIsHover=!1,this._areaIsDragging)this._x=e-this._posDragStartX,this._y=t-this._posDragStartY,i="move",s=this._areaIsHover=!0,this._events.trigger("area-move");else if(this._boxResizeIsDragging){var r,a,o;i="nesw-resize",a=e-this._posResizeStartX,r=(o=this._posResizeStartY-t)<a?this._posResizeStartSize+2*o:this._posResizeStartSize+2*a,this._size=Math.max(this._minSize,r),s=this._boxResizeIsHover=!0,this._events.trigger("area-resize")}else this._isCoordWithinBoxResize([e,t])?(i="nesw-resize",this._areaIsHover=!1,s=this._boxResizeIsHover=!0):this._isCoordWithinArea([e,t])&&(i="move",s=this._areaIsHover=!0);return this._dontDragOutside(),this._ctx.canvas.style.cursor=i,s},e.prototype.processMouseDown=function(e,t){this._isCoordWithinBoxResize([e,t])?(this._areaIsDragging=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!0,this._boxResizeIsHover=!0,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._boxResizeIsDragging=!1,this._boxResizeIsHover=!1,this._posDragStartX=e-this._x,this._posDragStartY=t-this._y,this._events.trigger("area-move-start"))},e.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},e}(n),c=function(s){function e(e,t){var i=s.call(this,e,t)||this;return i._resizeCtrlBaseRadius=10,i._resizeCtrlNormalRatio=.75,i._resizeCtrlHoverRatio=1,i._iconMoveNormalRatio=.9,i._iconMoveHoverRatio=1.2,i._posDragStartX=0,i._posDragStartY=0,i._posResizeStartX=0,i._posResizeStartY=0,i._posResizeStartSize=0,i._resizeCtrlIsHover=-1,i._areaIsHover=!1,i._resizeCtrlIsDragging=-1,i._areaIsDragging=!1,i._resizeCtrlNormalRadius=i._resizeCtrlBaseRadius*i._resizeCtrlNormalRatio,i._resizeCtrlHoverRadius=i._resizeCtrlBaseRadius*i._resizeCtrlHoverRatio,i}return t(e,s),e.prototype._calcSquareCorners=function(){var e=this._size/2;return[[this._x-e,this._y-e],[this._x+e,this._y-e],[this._x-e,this._y+e],[this._x+e,this._y+e]]},e.prototype._calcSquareDimensions=function(){var e=this._size/2;return{left:this._x-e,top:this._y-e,right:this._x+e,bottom:this._y+e}},e.prototype._isCoordWithinArea=function(e){var t=this._calcSquareDimensions();return e[0]>=t.left&&e[0]<=t.right&&e[1]>=t.top&&e[1]<=t.bottom},e.prototype._isCoordWithinResizeCtrl=function(e){for(var t=this._calcSquareCorners(),i=-1,s=0,r=t.length;s<r;s++){var a=t[s];if(e[0]>a[0]-this._resizeCtrlHoverRadius&&e[0]<a[0]+this._resizeCtrlHoverRadius&&e[1]>a[1]-this._resizeCtrlHoverRadius&&e[1]<a[1]+this._resizeCtrlHoverRadius){i=s;break}}return i},e.prototype._drawArea=function(e,t,i){var s=i/2;e.rect(t[0]-s,t[1]-s,i,i)},e.prototype.draw=function(){n.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var e=this._calcSquareCorners(),t=0,i=e.length;t<i;t++){var s=e[t];this._cropCanvas.drawIconResizeCircle(s,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===t?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},e.prototype.processMouseMove=function(e,t){var i="default",s=!1;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this._x=e-this._posDragStartX,this._y=t-this._posDragStartY,i="move",s=this._areaIsHover=!0,this._events.trigger("area-move");else if(-1<this._resizeCtrlIsDragging){var r,a;switch(this._resizeCtrlIsDragging){case 0:a=r=-1,i="nwse-resize";break;case 1:a=-(r=1),i="nesw-resize";break;case 2:r=-1,a=1,i="nesw-resize";break;case 3:a=r=1,i="nwse-resize"}var o,n=(e-this._posResizeStartX)*r,h=(t-this._posResizeStartY)*a;o=h<n?this._posResizeStartSize+h:this._posResizeStartSize+n;var c=this._size;this._size=Math.max(this._minSize,o);var l=(this._size-c)/2;this._x+=l*r,this._y+=l*a,this._resizeCtrlIsHover=this._resizeCtrlIsDragging,s=!0,this._events.trigger("area-resize")}else{var g=this._isCoordWithinResizeCtrl([e,t]);if(-1<g){switch(g){case 0:i="nwse-resize";break;case 1:case 2:i="nesw-resize";break;case 3:i="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=g,s=!0}else this._isCoordWithinArea([e,t])&&(i="move",s=this._areaIsHover=!0)}return this._dontDragOutside(),this._ctx.canvas.style.cursor=i,s},e.prototype.processMouseDown=function(e,t){var i=this._isCoordWithinResizeCtrl([e,t]);-1<i?(this._areaIsDragging=!1,this._areaIsHover=!1,this._resizeCtrlIsDragging=i,this._resizeCtrlIsHover=i,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._resizeCtrlIsDragging=-1,this._resizeCtrlIsHover=-1,this._posDragStartX=e-this._x,this._posDragStartY=t-this._y,this._events.trigger("area-move-start"))},e.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),-1<this._resizeCtrlIsDragging&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},e}(n),g=function(){function r(e,t,i){this.elCanvas=e,this.opts=t,this.events=i,this.ctx=null,this.image=null,this.minCanvasDims=[100,100],this.maxCanvasDims=[300,300],this.resultImageSize=200,this.resultImageFormat="image/png",this.element=e.parentElement,this.ctx=e.getContext("2d"),this.cropArea=new h(this.ctx,i),document.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("touchmove",this.onMouseMove.bind(this)),e.addEventListener("touchstart",this.onMouseDown.bind(this)),document.addEventListener("touchend",this.onMouseUp.bind(this))}return r.prototype.destroy=function(){document.removeEventListener("mousemove",this.onMouseMove),this.elCanvas.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mouseup",this.onMouseMove),document.removeEventListener("touchmove",this.onMouseMove),this.elCanvas.removeEventListener("touchstart",this.onMouseDown),document.removeEventListener("touchend",this.onMouseMove),this.elCanvas.remove()},r.prototype.drawScene=function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),null!==this.image&&(this.ctx.drawImage(this.image,0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.65)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore(),this.cropArea.draw())},r.prototype.resetCropHost=function(e,t){if(null!==this.image){this.cropArea.setImage(this.image);var i=this.image.width||e,s=this.image.height||t,r=i/s,a=[i,s];a[0]>this.maxCanvasDims[0]?(a[0]=this.maxCanvasDims[0],a[1]=a[0]/r):a[0]<this.minCanvasDims[0]&&(a[0]=this.minCanvasDims[0],a[1]=a[0]/r),a[1]>this.maxCanvasDims[1]?(a[1]=this.maxCanvasDims[1],a[0]=a[1]*r):a[1]<this.minCanvasDims[1]&&(a[1]=this.minCanvasDims[1],a[0]=a[1]*r);var o=Math.floor(a[0]),n=Math.floor(a[1]);a[0]=o,a[1]=n,console.debug("canvas reset ="+o+"x"+n),this.elCanvas.width=o,this.elCanvas.height=n,this.elCanvas.style.marginLeft=-o/2+"px",this.elCanvas.style.marginTop=-n/2+"px",this.cropArea.setX(this.ctx.canvas.width/2),this.cropArea.setY(this.ctx.canvas.height/2),this.cropArea.setSize(Math.min(200,this.ctx.canvas.width/2,this.ctx.canvas.height/2))}else this.elCanvas.width=0,this.elCanvas.height=0,this.elCanvas.style.marginLeft=0,this.elCanvas.style.marginTop=0;return this.drawScene(),a},r.getChangedTouches=function(e){return e.changedTouches?e.changedTouches:e.originalEvent.changedTouches},r.prototype.onMouseMove=function(e){if(null!==this.image){var t,i,s=r.getElementOffset(this.ctx.canvas);i="touchmove"===e.type?(t=r.getChangedTouches(e)[0].pageX,r.getChangedTouches(e)[0].pageY):(t=e.pageX,e.pageY),this.cropArea.processMouseMove(t-s.left,i-s.top),this.drawScene()}},r.prototype.onMouseDown=function(e){if(e.preventDefault(),e.stopPropagation(),null!==this.image){var t,i,s=r.getElementOffset(this.ctx.canvas);i="touchstart"===e.type?(t=r.getChangedTouches(e)[0].pageX,r.getChangedTouches(e)[0].pageY):(t=e.pageX,e.pageY),this.cropArea.processMouseDown(t-s.left,i-s.top),this.drawScene()}},r.prototype.onMouseUp=function(e){if(null!==this.image){var t,i,s=r.getElementOffset(this.ctx.canvas);i="touchend"===e.type?(t=r.getChangedTouches(e)[0].pageX,r.getChangedTouches(e)[0].pageY):(t=e.pageX,e.pageY),this.cropArea.processMouseUp(t-s.left,i-s.top),this.drawScene()}},r.prototype.getResultImageDataURI=function(){var e=document.createElement("CANVAS"),t=e.getContext("2d");return e.width=this.resultImageSize,e.height=this.resultImageSize,null!==this.image&&t.drawImage(this.image,(this.cropArea.getX()-this.cropArea.getSize()/2)*(this.image.width/this.ctx.canvas.width),(this.cropArea.getY()-this.cropArea.getSize()/2)*(this.image.height/this.ctx.canvas.height),this.cropArea.getSize()*(this.image.width/this.ctx.canvas.width),this.cropArea.getSize()*(this.image.height/this.ctx.canvas.height),0,0,this.resultImageSize,this.resultImageSize),null!==this.resultImageQuality?e.toDataURL(this.resultImageFormat,this.resultImageQuality):e.toDataURL(this.resultImageFormat)},r.prototype.redraw=function(){this.drawScene()},r.prototype.setNewImageSource=function(e){var t=this;if(this.image=null,this.resetCropHost(),this.events.trigger("image-updated"),e){var h=new Image;"http"===e.substring(0,4).toLowerCase()&&(h.crossOrigin="anonymous");var c=this;h.onload=function(){c.events.trigger("load-done"),l.getData(h,function(){var e=l.getTag(h,"Orientation"),t=h.width,i=h.height,s=0,r=0,a=0;function o(){console.debug("dims="+t+"x"+i);var e=c.resetCropHost(t,i);c.setMaxDimensions(e[0],e[1]),c.events.trigger("image-updated"),c.events.trigger("image-ready")}if(0<=[3,6,8].indexOf(e)){var n=document.createElement("canvas");n.getContext("2d");switch(e){case 3:s=-h.width,r=-h.height,a=180;break;case 6:t=h.height,i=h.width,r=-h.height,a=90;break;case 8:t=h.height,i=h.width,s=-h.width,a=270}n.width=t,n.height=i,c.ctx.rotate(a*Math.PI/180),c.ctx.drawImage(h,s,r),c.image=new Image,c.image.onload=function(){o()},c.image.src=n.toDataURL("image/png")}else c.image=h,o()})},h.onerror=function(e){t.events.trigger("load-error",[e])},this.events.trigger("load-start"),h.src=e}},r.prototype.setMaxDimensions=function(e,t){if(console.debug("setMaxDimensions("+e+", "+t+")"),null!==this.image){var i=this.ctx.canvas.width,s=this.ctx.canvas.height;this.ctx.canvas.width,this.ctx.canvas.height}return this.maxCanvasDims=[e,t],this.resetCropHost(e,t)},r.prototype.setAreaMinSize=function(e){e=parseInt(e,10),isNaN(e)||(this.cropArea.setMinSize(e),this.drawScene())},r.prototype.setResultImageSize=function(e){e=parseInt(e,10),isNaN(e)||(this.resultImageSize=e)},r.prototype.setResultImageFormat=function(e){this.resultImageFormat=e},r.prototype.setResultImageQuality=function(e){e=parseFloat(e),!isNaN(e)&&0<=e&&e<=1&&(this.resultImageQuality=e)},r.prototype.setAreaType=function(e){var t=this.cropArea.getSize(),i=this.cropArea.getMinSize(),s=this.cropArea.getX(),r=this.cropArea.getY();this.cropArea=e===o?new c(this.ctx,this.events):new h(this.ctx,this.events),this.cropArea.setMinSize(i),this.cropArea.setSize(t),this.cropArea.setX(s),this.cropArea.setY(r),null!==this.image&&this.cropArea.setImage(this.image),this.drawScene()},r.prototype.getAreaDetails=function(){return{x:this.cropArea.getX(),y:this.cropArea.getY(),size:this.cropArea.getSize(),image:{width:this.cropArea.getImage().width,height:this.cropArea.getImage().height},canvas:{width:this.ctx.canvas.width,height:this.ctx.canvas.height}}},r.getElementOffset=function(e){var t=e.getBoundingClientRect(),i=document.body,s=document.documentElement,r=window.pageYOffset||s.scrollTop||i.scrollTop,a=window.pageXOffset||s.scrollLeft||i.scrollLeft,o=s.clientTop||i.clientTop||0,n=s.clientLeft||i.clientLeft||0,h=t.top+r-o,c=t.left+a-n;return{top:Math.round(h),left:Math.round(c)}},r}(),u=function(){function e(e,t){this.el=e,this.ref=t,this.resultImageChange=new i.EventEmitter,this.areaDetailsChange=new i.EventEmitter,this.onChange=new i.EventEmitter,this.onLoadBegin=new i.EventEmitter,this.onLoadDone=new i.EventEmitter,this.onLoadError=new i.EventEmitter,this.onImageReady=new i.EventEmitter,this.events=new s}return e.prototype.ngOnInit=function(){var e=this.events,t=this.el.nativeElement.querySelector("canvas");this.cropHost=new g(t,{},e);var i=this;e.on("load-start",function(){i.onLoadBegin.emit({}),i.ref.detectChanges()}).on("load-done",function(){i.onLoadDone.emit({}),i.ref.detectChanges()}).on("image-ready",function(){i.onImageReady.emit({})&&(i.cropHost.redraw(),i.ref.detectChanges())}).on("load-error",function(){i.onLoadError.emit({}),i.ref.detectChanges()}).on("area-move area-resize",function(){i.changeOnFly&&(i.updateResultImage(),i.ref.detectChanges())}).on("area-move-end area-resize-end image-updated",function(){i.updateResultImage(),i.areaDetails=i.cropHost.getAreaDetails(),i.areaDetailsChange.emit(i.areaDetails)})},e.prototype.updateResultImage=function(){var e=this.cropHost.getResultImageDataURI();this.storedResultImage!==e&&(this.storedResultImage=e,this.resultImage=e,this.resultImageChange.observers.length&&this.resultImageChange.emit(this.resultImage),0<this.onChange.observers.length&&this.onChange.emit({$dataURI:this.resultImage}))},e.prototype.ngOnDestroy=function(){this.cropHost.destroy()},e.prototype.ngOnChanges=function(e){this.cropHost&&(e.image&&this.cropHost.setNewImageSource(this.image),e.areaType&&(this.cropHost.setAreaType(this.areaType),this.updateResultImage()),e.areaMinSize&&(this.cropHost.setAreaMinSize(this.areaMinSize),this.updateResultImage()),e.resultImageSize&&(this.cropHost.setResultImageSize(this.resultImageSize),this.updateResultImage()),e.resultImageFormat&&(this.cropHost.setResultImageFormat(this.resultImageFormat),this.updateResultImage()),e.resultImageQuality&&(this.cropHost.setResultImageQuality(this.resultImageQuality),this.updateResultImage()))},e.prototype.ngAfterViewInit=function(){var t=this;this.observer=new MutationObserver(function(e){e.forEach(function(e){"clientWidth"!==e.attributeName&&"clientHeight"!==e.attributeName||(t.cropHost.setMaxDimensions(t.el.nativeElement.clientWidth,t.el.nativeElement.clientHeight),t.updateResultImage())})});this.observer.observe(this.el.nativeElement,{attributes:!0,childList:!0,characterData:!0})},e.decorators=[{type:i.Component,args:[{selector:"fc-img-crop",template:"<canvas></canvas>",styles:[":host{width:100%;height:100%;display:block;position:relative;overflow:hidden}:host canvas{display:block;position:absolute;top:50%;left:50%;-webkit-tap-highlight-color:rgba(255,255,255,0)}"]}]}],e.ctorParameters=function(){return[{type:i.ElementRef},{type:i.ChangeDetectorRef}]},e.propDecorators={image:[{type:i.Input}],resultImage:[{type:i.Input}],resultImageChange:[{type:i.Output}],changeOnFly:[{type:i.Input}],areaType:[{type:i.Input}],areaMinSize:[{type:i.Input}],areaDetails:[{type:i.Input}],areaDetailsChange:[{type:i.Output}],resultImageSize:[{type:i.Input}],resultImageFormat:[{type:i.Input}],resultImageQuality:[{type:i.Input}],onChange:[{type:i.Output}],onLoadBegin:[{type:i.Output}],onLoadDone:[{type:i.Output}],onLoadError:[{type:i.Output}],onImageReady:[{type:i.Output}]},e}(),d=function(){function e(){}return e.decorators=[{type:i.NgModule,args:[{declarations:[u],exports:[u]}]}],e}();e.CropModule=d,e.ɵa=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ng-img-crop.umd.min.js.map